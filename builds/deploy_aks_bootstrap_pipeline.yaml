---
# -----------------------------------------------------------------------------
# Deploy AKS Bootstrap to support Inventory infrastructure
# -----------------------------------------------------------------------------
resources:
  containers:
  # Container image with ansible and azure collection installed
  - container: ansible_az
    image: aksbootstrap.azurecr.io/ansible_azure:dev
    endpoint: aksbootstrap

trigger: none

variables:
  # Get Ansible-Autmation secret
  - group: azure_automation

  - name: aksName
    value: aksbootstrap

  - name: acrName
    value: aksbootstrap

  - name: resourceGroup
    value: rg-aks-bootstrap-networking-spoke

  - name: aksPublicIpResourceGroup
    value: rg-francecentral-networking-hub

  - name: aksPublicIpDnsLabel
    value: inventory

  - name: aksPublicIpName
    value: pi-inventory-gateway

  - name:  applicationTestNameSpace
    value: ingress-controller

stages:
  - stage: deploy_aks
    displayName: Deploy AKS Bootstrap

    jobs:
      # -----------------------------------------------------------------------------
      # Create AKS Cluster
      # -----------------------------------------------------------------------------
      - job: create_cluster
        displayName: Create Aks Bootstrap
        pool:
          vmImage: 'ubuntu-latest'

        container: ansible_az

        steps:

          - task: Bash@3
            inputs:
                targetType: 'inline'
                workingDirectory: ansible
                script: |
                  echo ""
                  echo "Ansible version"
                  echo "=================================================="
                  ansible --version

                  echo ""
                  echo "Azure and kubernetes collections"
                  echo "=================================================="
                  ansible-galaxy collection list | grep azure.azcollection
                  ansible-galaxy collection list | grep kubernetes.core

                  echo ""
                  echo "Azure phyton modules"
                  echo "=================================================="
                  pip freeze | grep azure
            displayName: 'Display information'

          - task: Bash@3
            inputs:
                targetType: 'inline'
                workingDirectory: ansible
                script: |
                  ansible-playbook aks_create_cluster.yml -i inventory/ -e ansible_python_interpreter=/usr/bin/python3
            displayName: 'Create cluster'
            env:
              AZURE_TENANT: $(TenantId)
              AZURE_SUBSCRIPTION_ID: $(SubscriptionId)
              AZURE_CLIENT_ID: $(Ansible-Automation-ClientId)
              AZURE_SECRET: $(Ansible-Automation)

      # -----------------------------------------------------------------------------
      # Base Configuration for the cluster
      # -----------------------------------------------------------------------------
      - job: configure_cluster
        displayName: Configure Aks Bootstrap
        dependsOn:
          - create_cluster
        pool:
          vmImage: 'ubuntu-latest'

        steps:

          - task: AzureCLI@2
            inputs:
              azureSubscription: 'Ansible-Automation'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                az aks update -n $(aksName) -g $(resourceGroup) --attach-acr $(acrName) --enable-managed-identity
              addSpnToEnvironment: true
              useGlobalConfig: true
            displayName: 'Enable Managed identity and attach to ACR'
            continueOnError: true

          - task: AzureCLI@2
            inputs:
              azureSubscription: 'Ansible-Automation'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                az aks check-acr --resource-group $(resourceGroup) --name $(aksName) --acr aksbootstrap
              addSpnToEnvironment: true
              useGlobalConfig: true
            displayName: 'Check ACR access'

          - task: Kubernetes@1
            inputs:
              connectionType: 'Azure Resource Manager'
              azureSubscriptionEndpoint: 'Ansible-Automation'
              azureResourceGroup: 'rg-aks-bootstrap-networking-spoke'
              kubernetesCluster: 'aksbootstrap'
              command: 'apply'
              arguments: '-f https://raw.githubusercontent.com/kubernetes/dashboard/v2.7.0/aio/deploy/recommended.yaml'
              secretType: 'dockerRegistry'
              containerRegistryType: 'Azure Container Registry'
            displayName: 'Deploy standard kubernetes dashboard'

  - stage: cert_manager
    displayName: Configure cert-manager
    dependsOn:
      - deploy_aks

    jobs:
      # -----------------------------------------------------------------------------
      # Install Cert Manager
      # -----------------------------------------------------------------------------
      - job: configure_cert_manager
        displayName: Configure Cert-Manager
        pool:
            vmImage: 'ubuntu-latest'

        steps:

          - task: Bash@3
            inputs:
                targetType: 'inline'
                workingDirectory: ansible
                script: |
                  export
            displayName: 'Display environment'


          - task: AzureCLI@2
            inputs:
              azureSubscription: 'Ansible-Automation'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                # Install kubectl
                az aks install-cli

                # Get credentials for the AKS cluster
                az aks get-credentials --resource-group rg-aks-bootstrap-networking-spoke --name aksbootstrap

                if kubectl get namespace cert-manager; then
                  echo "Namespace cert-manager already exists"
                else
                  kubectl create namespace cert-manager
                fi

                # Run kubectl command
                kubectl label namespace cert-manager cert-manager.io/disable-validation=true
            displayName: 'Create cert-manager namespace'

          - task: Bash@3
            inputs:
              targetType: 'inline'
              script: |
                # Add the Jetstack Helm repository
                helm repo add jetstack https://charts.jetstack.io

                # Update your local Helm chart repository cache
                helm repo update
            displayName: 'Add jetstack repo'

          - task: HelmDeploy@0
            inputs:
              connectionType: 'Azure Resource Manager'
              azureSubscription: 'Ansible-Automation'
              azureResourceGroup: 'rg-aks-bootstrap-networking-spoke'
              kubernetesCluster: 'aksbootstrap'
              command: 'upgrade'
              chartType: 'Name'
              chartName: 'jetstack/cert-manager'
              releaseName: 'cert-manager'
              namespace: 'cert-manager'
              overrideValues: |
                installCRDs=true
                nodeSelector."kubernetes\.io/os"=linux

              recreate: true
              resetValues: true
              install: true
            displayName: 'Deploy cert manager'

  - stage: ingress_controller
    displayName: Configure ingress controller
    dependsOn:
      - cert_manager

    jobs:
      # -----------------------------------------------------------------------------
      # Install Ingress controller
      # -----------------------------------------------------------------------------
      - job: install_ingress_controller
        displayName: Install Ingress controller
        pool:
            vmImage: 'ubuntu-latest'

        steps:

          - task: Bash@3
            inputs:
                targetType: 'inline'
                workingDirectory: ansible
                script: |
                  export
            displayName: 'Display environment'


          - task: AzureCLI@2
            inputs:
              azureSubscription: 'Ansible-Automation'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                # Install kubectl
                az aks install-cli

                # Get credentials for the AKS cluster
                az aks get-credentials --resource-group rg-aks-bootstrap-networking-spoke --name aksbootstrap

                if kubectl get namespace ingress-controller; then
                  echo "Namespace ingress-controller already exists"
                else
                  kubectl create namespace ingress-controller
                fi

                # Run kubectl command
                kubectl label namespace ingress-controller cert-manager.io/disable-validation=true
            displayName: 'Create ingress-controller namespace'

          - task: AzureCLI@2
            inputs:
              azureSubscription: 'Ansible-Automation'
              scriptType: 'pscore'
              scriptLocation: 'inlineScript'
              inlineScript: |
                $publicIp = $(az network public-ip show -g $(aksPublicIpResourceGroup) -n $(aksPublicIpName) -o tsv --query "ipAddress")
                write-host "Found ip : $publicIp"
                Write-Host "##vso[task.setvariable variable=publicIp;]$publicIp"

            displayName: 'Retrieve Public IP value'

          - task: Bash@3
            inputs:
              targetType: 'inline'
              script: |
                # Add the  ingress-nginx Helm repository
                helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx

                # Update your local Helm chart repository cache
                helm repo update
            displayName: 'Add ingress-nginx repo'

          - task: HelmDeploy@0
            inputs:
              connectionType: 'Azure Resource Manager'
              azureSubscription: 'Ansible-Automation'
              azureResourceGroup: 'rg-aks-bootstrap-networking-spoke'
              kubernetesCluster: 'aksbootstrap'
              command: 'upgrade'
              chartType: 'Name'
              chartName: 'ingress-nginx/ingress-nginx'
              releaseName: 'ingress-nginx'
              namespace: 'ingress-controller'
              overrideValues: |
                controller.service.annotations."service\.beta\.kubernetes\.io/azure-load-balancer-resource-group"=$(aksPublicIpResourceGroup)
                controller.service.annotations."service\.beta\.kubernetes\.io/azure-load-balancer-health-probe-request-path"=/healthz
                controller.service.annotations."service\.beta\.kubernetes\.io/azure-dns-label-name"=$(aksPublicIpDnsLabel)
                controller.service.loadBalancerIP=$(publicIp)

              recreate: true
              resetValues: true
              install: true
            displayName: 'Deploy ingress controller'

      # -----------------------------------------------------------------------------
      # deploy application test
      # -----------------------------------------------------------------------------
      - job: deploy_test_application
        displayName: Deploy test application
        dependsOn:
          - install_ingress_controller
        pool:
            vmImage: 'ubuntu-latest'

        steps:
          - task: AzureCLI@2
            inputs:
              azureSubscription: 'Ansible-Automation'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                # Install kubectl
                az aks install-cli

                # Get credentials for the AKS cluster
                az aks get-credentials --resource-group rg-aks-bootstrap-networking-spoke --name aksbootstrap

                if kubectl get namespace $(applicationTestNameSpace); then
                  echo "Namespace $(applicationTestNameSpace) already exists"
                else
                  kubectl create namespace $(applicationTestNameSpace)
                fi

                # Run kubectl command
                kubectl label namespace $(applicationTestNameSpace) cert-manager.io/disable-validation=true
            displayName: 'Create application test namespace'

          - task: Kubernetes@1
            inputs:
              connectionType: 'Azure Resource Manager'
              azureSubscriptionEndpoint: 'Ansible-Automation'
              azureResourceGroup: 'rg-aks-bootstrap-networking-spoke'
              kubernetesCluster: 'aksbootstrap'
              command: 'apply'
              arguments: '-f ./resources/aks/aks-helloworld-one.yaml -f ./resources/aks/aks-helloworld-two.yaml'
              secretType: 'dockerRegistry'
              containerRegistryType: 'Azure Container Registry'
              namespace: $(applicationTestNameSpace)
            displayName: 'Deploy Helloworld'

          - task: Kubernetes@1
            inputs:
              connectionType: 'Azure Resource Manager'
              azureSubscriptionEndpoint: 'Ansible-Automation'
              azureResourceGroup: 'rg-aks-bootstrap-networking-spoke'
              kubernetesCluster: 'aksbootstrap'
              command: 'apply'
              arguments: '-f ./resources/aks/ingress.yaml'
              secretType: 'dockerRegistry'
              containerRegistryType: 'Azure Container Registry'
              namespace: $(applicationTestNameSpace)
            displayName: 'Deploy Helloworld ingress'
