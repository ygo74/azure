- name: Create Azure Kubernetes Service
  hosts: aks
  collections:
    - azure.azcollection
  vars:
    # resource_group: myResourceGroup
    # location: eastus
    # aks_name: myAKSCluster
    username: azureuser
    ssh_key: "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDNGcO1DqGmrA7l53di7659x4SJCzAt8bla7cgixfhuRStZWyKmULmzf2SNjuDT6e7quNzLzlucfm5E5Yi9S98kRX5MwIzM/8vQdM7Sh78CMsIPSCEdXJ1xoBGXAVMJszMwddbDQSxqsmezXTbSTDxUbQVChOGpJioaCEwUi5KqzgGJXcGAqmNZw1bC3UQ7fur5UBoeuEEpBfyi8AYGcDm5v3u2UHvA1Tcwl6ZnvFEYjc5JaD1SUJNSUP3gD7nH5LKhmVeVkebp724iTvlucEFdfKuC5/BkhI3VM/IgZJZmRep9RLeyYonVjNYewyhgYMWrrwB0cPDeWlDazUFtbZU5 azureuser"

    registry: '{{ registries[0] }}'


    client_id:     '{{ lookup("ansible.builtin.env", "AZURE_CLIENT_ID") }}'
    client_secret: '{{ lookup("ansible.builtin.env", "AZURE_SECRET") }}'
    tenant_id:     '{{ lookup("ansible.builtin.env", "AZURE_TENANT") }}'


  tasks:

    - name: Get cluster config
      tags:
        - always
      include_tasks: ./tasks/aks/cluster_config_get.yml
      when:
        - _kubeconfig_file_path is not defined


    - name: Deploy Dashboard
      block:

        - name: Download dashboard manifest to the cluster.
          ansible.builtin.get_url:
            url:  '{{ dashboard_manifest_uri }}'
            dest: '~/dashboard-manifest.yaml'
            mode: '0664'

        - name: Apply Dashboard manifest to the cluster.
          kubernetes.core.k8s:
            state:      'present'
            src:        '~/dashboard-manifest.yaml'
            kubeconfig: '{{ _kubeconfig_file_path }}'